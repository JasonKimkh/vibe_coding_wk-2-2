name: PR ìë™ ì½”ë“œ ë¦¬ë·°

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ë³€ê²½ì‚¬í•­ ë¶„ì„ ë° ìë™ ë¦¬ë·° ëŒ“ê¸€
      uses: actions/github-script@v7
      with:
        script: |
          // PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          let reviewComments = [];
          let generalComments = [];
          
          // íŒŒì¼ë³„ ìë™ ë¦¬ë·° ì²´í¬
          files.forEach(file => {
            // Python íŒŒì¼ ì²´í¬
            if (file.filename.endsWith('.py')) {
              // íŒŒì¼ í¬ê¸° ì²´í¬
              if (file.additions > 300) {
                generalComments.push(`âš ï¸ **${file.filename}**: íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (${file.additions}ì¤„ ì¶”ê°€). ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„í• ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`);
              }
              
              // í…ŒìŠ¤íŠ¸ íŒŒì¼ í™•ì¸
              if (!file.filename.includes('test') && !files.some(f => f.filename.includes('test') && f.filename.includes(file.filename.replace('.py', '')))) {
                generalComments.push(`ğŸ§ª **${file.filename}**: ê´€ë ¨ í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ì¶”ê°€ë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”.`);
              }
            }
            
            // ì„¤ì • íŒŒì¼ ë³€ê²½ ì²´í¬
            if (file.filename.includes('requirements.txt') || file.filename.includes('.env')) {
              generalComments.push(`âš™ï¸ **${file.filename}**: ì„¤ì • íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë¬¸ì„œ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`);
            }
          });
          
          // ì „ì²´ì ì¸ PR ë¶„ì„
          const totalAdditions = files.reduce((sum, file) => sum + file.additions, 0);
          const totalDeletions = files.reduce((sum, file) => sum + file.deletions, 0);
          
          let summary = `## ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·° ìš”ì•½\n\n`;
          summary += `ğŸ“Š **ë³€ê²½ì‚¬í•­ í†µê³„:**\n`;
          summary += `- ë³€ê²½ëœ íŒŒì¼: ${files.length}ê°œ\n`;
          summary += `- ì¶”ê°€ëœ ì¤„: ${totalAdditions}ì¤„\n`;
          summary += `- ì‚­ì œëœ ì¤„: ${totalDeletions}ì¤„\n\n`;
          
          // ê¶Œì¥ì‚¬í•­ ì¶”ê°€
          if (generalComments.length > 0) {
            summary += `### ğŸ“ ê²€í†  ê¶Œì¥ì‚¬í•­:\n`;
            generalComments.forEach(comment => {
              summary += `${comment}\n`;
            });
            summary += `\n`;
          }
          
          summary += `### âœ… ìë™ ì²´í¬ í•­ëª©:\n`;
          summary += `- [${totalAdditions < 500 ? 'x' : ' '}] ì ì ˆí•œ í¬ê¸°ì˜ PR (500ì¤„ ë¯¸ë§Œ)\n`;
          summary += `- [${files.some(f => f.filename.includes('test')) ? 'x' : ' '}] í…ŒìŠ¤íŠ¸ íŒŒì¼ í¬í•¨\n`;
          summary += `- [${files.some(f => f.filename.endsWith('.md')) ? 'x' : ' '}] ë¬¸ì„œ ì—…ë°ì´íŠ¸ í¬í•¨\n\n`;
          
          summary += `> ì´ê²ƒì€ ìë™ ìƒì„±ëœ ë¦¬ë·°ì…ë‹ˆë‹¤. ìˆ˜ë™ ë¦¬ë·°ë„ í•¨ê»˜ ì§„í–‰í•´ì£¼ì„¸ìš”! ğŸ‘¥`;
          
          // ëŒ“ê¸€ ì¶”ê°€
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          }); 